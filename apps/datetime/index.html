<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <!-- Safari specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <!-- Default color (fallback) -->
  <meta name="theme-color" content="#191919" />
  <!-- Color for light theme -->
  <meta name="theme-color" content="#DDDDDD" media="(prefers-color-scheme: light)" />
  <!-- Color for dark theme -->
  <meta name="theme-color" content="#191919" media="(prefers-color-scheme: dark)" />
  <title>DateTime Picker</title>
  <link rel="stylesheet" href="../../shared/ui.css">
  <style>
    /* Duration picker specific styles */
    .duration-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin: 24px 0;
    }
    .duration-input {
      width: 100px;
      padding: 6px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--glass-soft);
      color: var(--text);
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      outline: none;
    }
    .duration-unit {
      font-size: 18px;
      font-weight: 600;
      color: var(--muted);
    }
    .duration-tokens {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .duration-token {
      padding: 6px;
      border-radius: 14px;
      color: var(--text);
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      text-align: center;
    }
    .duration-token:hover {
      background: var(--glass);
    }

    /* View containers */
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    /* Back button styles */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      margin-bottom: 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--glass-soft);
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .back-btn:hover {
      background: var(--glass);
    }

    /* New time picker layout styles */
    .time-picker-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    .time-hour-rows {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }
    .time-hour-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    .time-hour-btn {
      aspect-ratio: 1;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--glass-soft);
      color: var(--text);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .time-hour-btn:hover {
      background: var(--glass);
    }
    .time-hour-btn.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .time-minute-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .time-minute-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 1px solid var(--stroke);
      background: var(--glass-soft);
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .time-minute-btn:hover {
      background: var(--glass);
    }
    .time-minute-btn.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .time-period-selector {
      display: inline-flex;
      border-radius: 999px;
      background: var(--glass-soft);
      border: 1px solid var(--stroke);
      overflow: hidden;
    }
    .time-period-btn {
      padding: 10px 24px;
      border: none;
      background: transparent;
      color: var(--text);
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .time-period-btn.selected {
      background: var(--accent);
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="sheet">
      <div class="content">
        <div class="datetime-display">
          <div class="datetime-display-date" id="displayDate">Thursday, December 25, 2025</div>
          <div class="datetime-display-time" id="displayTime">12:00 PM</div>
        </div>
        <!-- Combined Date & Time View -->
        <div class="view active" id="view-datetime">
          <div class="card glass-card">
            

            <div class="month-year-selector">
              <div class="month-year-pill glass-pill">
                <button id="monthBtn">December</button>
                <div class="divider"></div>
                <button id="yearBtn">2025</button>
              </div>
              <div class="nav-arrows">
                <button class="nav-arrow-btn" id="prevMonth">&#x2039;</button>
                <button class="nav-arrow-btn" id="nextMonth">&#x203A;</button>
              </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>

        <!-- Time Selection View -->
        <div class="view" id="view-time">
          <div class="card glass-card">
            <button class="btn back-btn" id="backToDateBtn">
              <span>&#x2039;</span> Back to Date
            </button>
            <div class="time-picker-grid" id="timePickerGrid"></div>
          </div>
        </div>

        <!-- Duration Selection View -->
        <div class="view" id="view-duration">
          <div class="card glass-card">
            <button class="btn back-btn" id="backToTimeBtn">
              <span>&#x2039;</span> Back to Time
            </button>
            <div class="label" style="text-align: center; font-size: 14px;">How long?</div>
            <div class="duration-input-group">
              <input type="number" class="duration-input" id="durationInput" value="30" min="1" max="1440" />
              <span class="duration-unit">minutes</span>
            </div>
            <div class="duration-tokens">
          <button class="chip duration-token" data-duration="15">15 min</button>
          <button class="chip duration-token" data-duration="30">30 min</button>
          <button class="chip duration-token" data-duration="60">1 hour</button>
          <button class="chip duration-token" data-duration="90">1.5 hours</button>
          <button class="chip duration-token" data-duration="120">2 hours</button>
          <button class="chip duration-token" data-duration="180">3 hours</button>
            </div>
            <div style="margin-top: 24px; text-align: center;">
              <button class="btn btnPrimary" id="doneBtn" style="padding: 12px 32px; font-size: 16px;">Done</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Month picker overlay -->
  <div class="picker-overlay" id="monthPicker">
    <div class="picker-panel">
      <div class="label">Select Month</div>
      <div class="picker-grid" id="monthGrid"></div>
    </div>
  </div>

  <!-- Year picker overlay -->
  <div class="picker-overlay" id="yearPicker">
    <div class="picker-panel">
      <div class="label">Select Year</div>
      <div class="picker-grid" id="yearGrid"></div>
    </div>
  </div>

  <script type="module">
    import { q, returnToShortcuts } from "../../shared/bridge.js";

    const rid = q("rid", crypto.randomUUID());
    const cb = q("cb", "UI DateTime Picker");
    const initialIso = q("initial", null);

    // Calculate and set gradient angle based on aspect ratio
    function updateGradientAngles() {
      const cards = document.querySelectorAll('.glass-card, .glass-pill, .btn');
      cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;
        // Calculate angle of diagonal in degrees
        const angleRad = Math.atan2(height, width);
        const angleDeg = angleRad * (180 / Math.PI);
        card.style.setProperty('--gradient-angle', `${angleDeg}deg`);
      });
    }

    // Update gradient angles on load and resize
    window.addEventListener('load', updateGradientAngles);
    window.addEventListener('resize', updateGradientAngles);
    // Use ResizeObserver for dynamic content changes
    const resizeObserver = new ResizeObserver(updateGradientAngles);
    document.querySelectorAll('.glass-card, .glass-pill').forEach(el => {
      resizeObserver.observe(el);
    });

    // State
    let currentStep = 0;
    let selectedDate = new Date();
    let selectedHour = 12;
    let selectedMinute = 0;
    let selectedPeriod = 'PM';
    let selectedDuration = 30;
    let calendarMonth = new Date().getMonth();
    let calendarYear = new Date().getFullYear();

    // Initialize from query param if provided
    if (initialIso) {
      const decoded = decodeURIComponent(initialIso);
      const parsed = new Date(decoded);
      if (!isNaN(parsed.getTime())) {
        selectedDate = parsed;
        calendarMonth = parsed.getMonth();
        calendarYear = parsed.getFullYear();
        const hours = parsed.getHours();
        selectedHour = hours % 12 || 12;
        selectedPeriod = hours >= 12 ? 'PM' : 'AM';
        selectedMinute = Math.floor(parsed.getMinutes() / 15) * 15;
      }
    }

    // Elements
    const views = [
      document.getElementById('view-datetime'),
      document.getElementById('view-time'),
      document.getElementById('view-duration')
    ];

    // Format functions
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    const monthsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function formatDateDisplay() {
      const day = weekdays[selectedDate.getDay()];
      const month = months[selectedDate.getMonth()];
      const date = selectedDate.getDate();
      const year = selectedDate.getFullYear();
      return `${day}, ${month} ${date}, ${year}`;
    }

    function formatTimeDisplay() {
      const minute = String(selectedMinute).padStart(2, '0');
      return `${selectedHour}:${minute} ${selectedPeriod}`;
    }

    function updateDisplay() {
      const dateStr = formatDateDisplay();
      const timeStr = formatTimeDisplay();

      document.getElementById('displayDate').textContent = dateStr;
      document.getElementById('displayTime').textContent = timeStr;
    }

    function showView(step) {
      views.forEach((view, i) => {
        view.classList.toggle('active', i === step);
      });
      updateDisplay();
    }

    // Calendar rendering
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // Day headers
      const dayHeaders = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
      });

      // Get first day of month and number of days
      const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(calendarYear, calendarMonth, 0).getDate();

      const today = new Date();
      const isCurrentMonth = today.getMonth() === calendarMonth && today.getFullYear() === calendarYear;

      // Helper to create calendar day button
      function createDayBtn(day, isOtherMonth, onClick) {
        const btn = document.createElement('button');
        btn.className = 'calendar-day' + (isOtherMonth ? ' other-month' : '');
        const span = document.createElement('span');
        span.textContent = day;
        btn.appendChild(span);
        btn.onclick = onClick;
        return btn;
      }

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const btn = createDayBtn(day, true, () => {
          calendarMonth--;
          if (calendarMonth < 0) {
            calendarMonth = 11;
            calendarYear--;
          }
          selectedDate = new Date(calendarYear, calendarMonth, day);
          renderCalendar();
          updateDisplay();
          currentStep = 1;
          showView(currentStep);
          renderTimePicker();
        });
        grid.appendChild(btn);
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const isSelected = selectedDate.getDate() === day &&
                          selectedDate.getMonth() === calendarMonth &&
                          selectedDate.getFullYear() === calendarYear;
        const isToday = isCurrentMonth && today.getDate() === day;

        const btn = createDayBtn(day, false, () => {
          selectedDate = new Date(calendarYear, calendarMonth, day);
          renderCalendar();
          updateDisplay();
          currentStep = 1;
          showView(currentStep);
          renderTimePicker();
        });

        if (isToday) btn.classList.add('today');
        if (isSelected) btn.classList.add('selected');
        grid.appendChild(btn);
      }

      // Next month days
      const totalCells = grid.children.length - 7;
      const remainingCells = 42 - totalCells - 7;
      for (let day = 1; day <= remainingCells; day++) {
        const btn = createDayBtn(day, true, () => {
          calendarMonth++;
          if (calendarMonth > 11) {
            calendarMonth = 0;
            calendarYear++;
          }
          selectedDate = new Date(calendarYear, calendarMonth, day);
          renderCalendar();
          updateDisplay();
          currentStep = 1;
          showView(currentStep);
          renderTimePicker();
        });
        grid.appendChild(btn);
      }

      // Update month/year buttons
      document.getElementById('monthBtn').textContent = months[calendarMonth];
      document.getElementById('yearBtn').textContent = calendarYear;
    }

    // Time picker rendering with new standard layout
    function renderTimePicker() {
      const grid = document.getElementById('timePickerGrid');
      grid.innerHTML = '';

      // Hour buttons - two rows of 6 (1-6, then 7-12)
      const hourRows = document.createElement('div');
      hourRows.className = 'time-hour-rows';

      // First row: 1-6
      const row1 = document.createElement('div');
      row1.className = 'time-hour-row';
      for (let i = 1; i <= 6; i++) {
        const btn = document.createElement('button');
        btn.className = 'time-hour-btn';
        btn.textContent = i;
        if (i === selectedHour) btn.classList.add('selected');
        btn.onclick = () => {
          selectedHour = i;
          renderTimePicker();
          updateDisplay();
        };
        row1.appendChild(btn);
      }
      hourRows.appendChild(row1);

      // Second row: 7-12
      const row2 = document.createElement('div');
      row2.className = 'time-hour-row';
      for (let i = 7; i <= 12; i++) {
        const btn = document.createElement('button');
        btn.className = 'time-hour-btn';
        btn.textContent = i;
        if (i === selectedHour) btn.classList.add('selected');
        btn.onclick = () => {
          selectedHour = i;
          renderTimePicker();
          updateDisplay();
        };
        row2.appendChild(btn);
      }
      hourRows.appendChild(row2);
      grid.appendChild(hourRows);

      // Minute buttons - four circular buttons (:00, :15, :30, :45)
      const minuteButtons = document.createElement('div');
      minuteButtons.className = 'time-minute-buttons';
      const minutes = [0, 15, 30, 45];
      minutes.forEach(min => {
        const btn = document.createElement('button');
        btn.className = 'time-minute-btn';
        btn.textContent = `:${String(min).padStart(2, '0')}`;
        if (min === selectedMinute) btn.classList.add('selected');
        btn.onclick = () => {
          selectedMinute = min;
          renderTimePicker();
          updateDisplay();
        };
        minuteButtons.appendChild(btn);
      });
      grid.appendChild(minuteButtons);

      // AM/PM selector - joined capsule
      const periodSelector = document.createElement('div');
      periodSelector.className = 'time-period-selector';

      const amBtn = document.createElement('button');
      amBtn.className = 'time-period-btn';
      amBtn.textContent = 'AM';
      if (selectedPeriod === 'AM') amBtn.classList.add('selected');
      amBtn.onclick = () => {
        selectedPeriod = 'AM';
        renderTimePicker();
        updateDisplay();
      };
      periodSelector.appendChild(amBtn);

      const pmBtn = document.createElement('button');
      pmBtn.className = 'time-period-btn';
      pmBtn.textContent = 'PM';
      if (selectedPeriod === 'PM') pmBtn.classList.add('selected');
      pmBtn.onclick = () => {
        selectedPeriod = 'PM';
        renderTimePicker();
        updateDisplay();
        // Auto-advance to duration picker
        currentStep = 2;
        showView(currentStep);
      };
      periodSelector.appendChild(pmBtn);

      grid.appendChild(periodSelector);

      // Update gradient angles for new elements
      setTimeout(updateGradientAngles, 0);
    }

    // Month picker
    document.getElementById('monthBtn').onclick = () => {
      const picker = document.getElementById('monthPicker');
      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';

      monthsShort.forEach((month, i) => {
        const btn = document.createElement('button');
        btn.className = 'picker-item';
        btn.textContent = month;
        if (i === calendarMonth) btn.classList.add('selected');
        btn.onclick = () => {
          calendarMonth = i;
          renderCalendar();
          picker.classList.remove('active');
        };
        grid.appendChild(btn);
      });

      picker.classList.add('active');
    };

    // Year picker
    document.getElementById('yearBtn').onclick = () => {
      const picker = document.getElementById('yearPicker');
      const grid = document.getElementById('yearGrid');
      grid.innerHTML = '';

      const currentYear = new Date().getFullYear();
      const years = [];
      for (let i = currentYear - 5; i <= currentYear + 10; i++) {
        years.push(i);
      }

      years.forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'picker-item';
        btn.textContent = year;
        if (year === calendarYear) btn.classList.add('selected');
        btn.onclick = () => {
          calendarYear = year;
          renderCalendar();
          picker.classList.remove('active');
        };
        grid.appendChild(btn);
      });

      picker.classList.add('active');
    };

    // Close pickers when clicking overlay
    document.getElementById('monthPicker').onclick = (e) => {
      if (e.target.id === 'monthPicker') {
        e.target.classList.remove('active');
      }
    };
    document.getElementById('yearPicker').onclick = (e) => {
      if (e.target.id === 'yearPicker') {
        e.target.classList.remove('active');
      }
    };

    // Month navigation
    document.getElementById('prevMonth').onclick = () => {
      calendarMonth--;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendar();
    };

    document.getElementById('nextMonth').onclick = () => {
      calendarMonth++;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      }
      renderCalendar();
    };

    // Back button handlers
    document.getElementById('backToDateBtn').onclick = () => {
      currentStep = 0;
      showView(currentStep);
    };

    document.getElementById('backToTimeBtn').onclick = () => {
      currentStep = 1;
      showView(currentStep);
      renderTimePicker();
    };

    // Duration tokens
    document.querySelectorAll('.duration-token').forEach(token => {
      token.onclick = () => {
        selectedDuration = parseInt(token.dataset.duration);
        document.getElementById('durationInput').value = selectedDuration;
      };
    });

    document.getElementById('durationInput').oninput = (e) => {
      selectedDuration = parseInt(e.target.value) || 1;
    };

    // Done button
    document.getElementById('doneBtn').onclick = () => {
      finalizeDateTimePicker();
    };

    // Function to finalize and return result
    function finalizeDateTimePicker() {
      const date = new Date(selectedDate);
      const hour24 = selectedPeriod === 'PM' ? (selectedHour % 12) + 12 : (selectedHour % 12);
      date.setHours(hour24, selectedMinute, 0, 0);

      function pad2(n){ return String(n).padStart(2,"0"); }
      function isoWithOffset(d){
        const offMin = -d.getTimezoneOffset();
        const sign = offMin >= 0 ? "+" : "-";
        const abs = Math.abs(offMin);
        const hh = pad2(Math.floor(abs / 60));
        const mm = pad2(abs % 60);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}${sign}${hh}:${mm}`;
      }

      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "local";
      const dtf = new Intl.DateTimeFormat(undefined, {
        weekday:"short", year:"numeric", month:"short", day:"2-digit",
        hour:"numeric", minute:"2-digit"
      });

      const payload = {
        v: 1,
        rid,
        status: "ok",
        type: "datetime",
        data: {
          iso: isoWithOffset(date),
          epochMs: date.getTime(),
          tz,
          display: dtf.format(date),
          durationMin: selectedDuration
        }
      };

      returnToShortcuts(cb, payload);
    }

    // Initialize
    renderCalendar();
    showView(0);
    updateDisplay();
  </script>
</body>
</html>
