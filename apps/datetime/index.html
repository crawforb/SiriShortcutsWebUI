<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DateTime Picker</title>
  <link rel="stylesheet" href="../../shared/ui.css">
  <style>
    /* Duration picker specific styles */
    .duration-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin: 24px 0;
    }
    .duration-input {
      width: 100px;
      padding: 6px;
      border-radius: 14px;
      border: 1px solid rgba(160,160,160,.20);
      background: rgba(160,160,160,.10);
      color: var(--text);
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      outline: none;
    }
    .duration-unit {
      font-size: 18px;
      font-weight: 600;
      color: var(--muted);
    }
    .duration-tokens {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .duration-token {
      padding: 6px;
      border-radius: 14px;
      border: 1px solid rgba(160,160,160,.18);
      background: rgba(160,160,160,.08);
      color: var(--text);
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      text-align: center;
    }
    .duration-token:hover {
      background: rgba(160,160,160,.15);
    }

    /* View containers */
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="sheet">
      <div class="picker-header">
        <button class="picker-close-btn" id="closeBtn">&#x2715;</button>
        <span class="picker-title">Pick Date and Time</span>
      </div>

      <div class="content" style="padding-bottom: 20px;">
        <!-- Combined Date & Time View -->
        <div class="view active" id="view-datetime">
          <div class="datetime-display">
            <div class="datetime-display-date" id="displayDate">Thursday, December 25, 2025</div>
            <div class="datetime-display-time" id="displayTime">12:00 PM</div>
          </div>

          <div class="card">
            <div class="month-year-selector">
              <div class="month-year-pill">
                <button id="monthBtn">December</button>
                <div class="divider"></div>
                <button id="yearBtn">2025</button>
              </div>
              <div class="nav-arrows">
                <button class="nav-arrow-btn" id="prevMonth">&#x2039;</button>
                <button class="nav-arrow-btn" id="nextMonth">&#x203A;</button>
              </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>

        <!-- Time Selection View -->
        <div class="view" id="view-time">
          <div class="datetime-display">
            <div class="datetime-display-date" id="displayDate2">Thursday, December 25, 2025</div>
            <div class="datetime-display-time" id="displayTime2">12:00 PM</div>
          </div>

          <div class="card">
            <div class="time-picker-container">
              <div class="time-circle" id="timeCircle"></div>
            </div>
          </div>
        </div>

        <!-- Duration Selection View -->
        <div class="view" id="view-duration">
          <div class="card">
            <div class="label" style="text-align: center; font-size: 14px;">How long?</div>
            <div class="duration-input-group">
              <input type="number" class="duration-input" id="durationInput" value="30" min="1" max="1440" />
              <span class="duration-unit">minutes</span>
            </div>
            <div class="duration-tokens">
              <div class="duration-token" data-duration="15">15 min</div>
              <div class="duration-token" data-duration="30">30 min</div>
              <div class="duration-token" data-duration="60">1 hour</div>
              <div class="duration-token" data-duration="90">1.5 hours</div>
              <div class="duration-token" data-duration="120">2 hours</div>
              <div class="duration-token" data-duration="180">3 hours</div>
            </div>
            <div style="margin-top: 24px; text-align: center;">
              <button class="btn btnPrimary" id="doneBtn" style="padding: 12px 32px; font-size: 16px;">Done</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Month picker overlay -->
  <div class="picker-overlay" id="monthPicker">
    <div class="picker-panel">
      <div class="label">Select Month</div>
      <div class="picker-grid" id="monthGrid"></div>
    </div>
  </div>

  <!-- Year picker overlay -->
  <div class="picker-overlay" id="yearPicker">
    <div class="picker-panel">
      <div class="label">Select Year</div>
      <div class="picker-grid" id="yearGrid"></div>
    </div>
  </div>

  <script type="module">
    import { q, returnToShortcuts } from "../../shared/bridge.js";

    const rid = q("rid", crypto.randomUUID());
    const cb = q("cb", "UI DateTime Picker");
    const initialIso = q("initial", null);

    // State
    let currentStep = 0;
    let selectedDate = new Date();
    let selectedHour = 12;
    let selectedMinute = 0;
    let selectedPeriod = 'PM';
    let selectedDuration = 30;
    let calendarMonth = new Date().getMonth();
    let calendarYear = new Date().getFullYear();

    // Initialize from query param if provided
    if (initialIso) {
      const decoded = decodeURIComponent(initialIso);
      const parsed = new Date(decoded);
      if (!isNaN(parsed.getTime())) {
        selectedDate = parsed;
        calendarMonth = parsed.getMonth();
        calendarYear = parsed.getFullYear();
        const hours = parsed.getHours();
        selectedHour = hours % 12 || 12;
        selectedPeriod = hours >= 12 ? 'PM' : 'AM';
        selectedMinute = Math.floor(parsed.getMinutes() / 15) * 15;
      }
    }

    // Elements
    const views = [
      document.getElementById('view-datetime'),
      document.getElementById('view-time'),
      document.getElementById('view-duration')
    ];

    // Format functions
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    const monthsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function formatDateDisplay() {
      const day = weekdays[selectedDate.getDay()];
      const month = months[selectedDate.getMonth()];
      const date = selectedDate.getDate();
      const year = selectedDate.getFullYear();
      return `${day}, ${month} ${date}, ${year}`;
    }

    function formatTimeDisplay() {
      const minute = String(selectedMinute).padStart(2, '0');
      return `${selectedHour}:${minute} ${selectedPeriod}`;
    }

    function updateDisplay() {
      const dateStr = formatDateDisplay();
      const timeStr = formatTimeDisplay();

      document.getElementById('displayDate').textContent = dateStr;
      document.getElementById('displayTime').textContent = timeStr;
      document.getElementById('displayDate2').textContent = dateStr;
      document.getElementById('displayTime2').textContent = timeStr;
    }

    function showView(step) {
      views.forEach((view, i) => {
        view.classList.toggle('active', i === step);
      });
      updateDisplay();
    }

    // Calendar rendering
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // Day headers
      const dayHeaders = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
      });

      // Get first day of month and number of days
      const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(calendarYear, calendarMonth, 0).getDate();

      const today = new Date();
      const isCurrentMonth = today.getMonth() === calendarMonth && today.getFullYear() === calendarYear;

      // Helper to create calendar day button
      function createDayBtn(day, isOtherMonth, onClick) {
        const btn = document.createElement('button');
        btn.className = 'calendar-day' + (isOtherMonth ? ' other-month' : '');
        const span = document.createElement('span');
        span.textContent = day;
        btn.appendChild(span);
        btn.onclick = onClick;
        return btn;
      }

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const btn = createDayBtn(day, true, () => {
          calendarMonth--;
          if (calendarMonth < 0) {
            calendarMonth = 11;
            calendarYear--;
          }
          selectedDate = new Date(calendarYear, calendarMonth, day);
          renderCalendar();
          updateDisplay();
          currentStep = 1;
          showView(currentStep);
          renderTimePicker();
        });
        grid.appendChild(btn);
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const isSelected = selectedDate.getDate() === day &&
                          selectedDate.getMonth() === calendarMonth &&
                          selectedDate.getFullYear() === calendarYear;
        const isToday = isCurrentMonth && today.getDate() === day;

        const btn = createDayBtn(day, false, () => {
          selectedDate = new Date(calendarYear, calendarMonth, day);
          renderCalendar();
          updateDisplay();
          currentStep = 1;
          showView(currentStep);
          renderTimePicker();
        });

        if (isToday) btn.classList.add('today');
        if (isSelected) btn.classList.add('selected');
        grid.appendChild(btn);
      }

      // Next month days
      const totalCells = grid.children.length - 7;
      const remainingCells = 42 - totalCells - 7;
      for (let day = 1; day <= remainingCells; day++) {
        const btn = createDayBtn(day, true, () => {
          calendarMonth++;
          if (calendarMonth > 11) {
            calendarMonth = 0;
            calendarYear++;
          }
          selectedDate = new Date(calendarYear, calendarMonth, day);
          renderCalendar();
          updateDisplay();
          currentStep = 1;
          showView(currentStep);
          renderTimePicker();
        });
        grid.appendChild(btn);
      }

      // Update month/year buttons
      document.getElementById('monthBtn').textContent = months[calendarMonth];
      document.getElementById('yearBtn').textContent = calendarYear;
    }

    // Time picker rendering
    function renderTimePicker() {
      const circle = document.getElementById('timeCircle');
      circle.innerHTML = '';

      const centerX = 50;
      const centerY = 50;
      const hourRadius = 38;

      // Hour positions (12, 1, 2, ..., 11)
      for (let i = 0; i < 12; i++) {
        const hour = i === 0 ? 12 : i;
        const angle = (i * 30 - 90) * Math.PI / 180;
        const x = centerX + hourRadius * Math.cos(angle);
        const y = centerY + hourRadius * Math.sin(angle);

        const btn = document.createElement('button');
        btn.className = 'time-btn hour-btn';
        btn.textContent = hour;
        btn.style.left = `${x}%`;
        btn.style.top = `${y}%`;
        btn.style.transform = 'translate(-50%, -50%)';

        if (hour === selectedHour) btn.classList.add('selected');

        btn.onclick = () => {
          selectedHour = hour;
          renderTimePicker();
          updateDisplay();
        };
        circle.appendChild(btn);
      }

      // Minute positions (:00, :15, :30, :45) - diamond layout
      const minutes = [0, 15, 30, 45];
      const minutePositions = [
        { x: 50, y: 20 },   // :00 top
        { x: 72, y: 50 },   // :15 right
        { x: 50, y: 80 },   // :30 bottom
        { x: 28, y: 50 }    // :45 left
      ];

      minutes.forEach((min, i) => {
        const btn = document.createElement('button');
        btn.className = 'time-btn minute-btn';
        btn.textContent = `:${String(min).padStart(2, '0')}`;
        btn.style.left = `${minutePositions[i].x}%`;
        btn.style.top = `${minutePositions[i].y}%`;
        btn.style.transform = 'translate(-50%, -50%)';

        if (min === selectedMinute) btn.classList.add('selected');

        btn.onclick = () => {
          selectedMinute = min;
          renderTimePicker();
          updateDisplay();
        };
        circle.appendChild(btn);
      });

      // AM/PM buttons - positioned at bottom
      const periods = ['AM', 'PM'];
      const periodPositions = [
        { x: 35, y: 95 },   // AM bottom-left
        { x: 65, y: 95 }    // PM bottom-right
      ];

      periods.forEach((period, i) => {
        const btn = document.createElement('button');
        btn.className = 'time-btn period-btn';
        btn.textContent = period;
        btn.style.left = `${periodPositions[i].x}%`;
        btn.style.top = `${periodPositions[i].y}%`;
        btn.style.transform = 'translate(-50%, -50%)';

        if (period === selectedPeriod) btn.classList.add('selected');

        btn.onclick = () => {
          selectedPeriod = period;
          renderTimePicker();
          updateDisplay();
          // Auto-advance to duration picker
          currentStep = 2;
          showView(currentStep);
        };
        circle.appendChild(btn);
      });
    }

    // Month picker
    document.getElementById('monthBtn').onclick = () => {
      const picker = document.getElementById('monthPicker');
      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';

      monthsShort.forEach((month, i) => {
        const btn = document.createElement('button');
        btn.className = 'picker-item';
        btn.textContent = month;
        if (i === calendarMonth) btn.classList.add('selected');
        btn.onclick = () => {
          calendarMonth = i;
          renderCalendar();
          picker.classList.remove('active');
        };
        grid.appendChild(btn);
      });

      picker.classList.add('active');
    };

    // Year picker
    document.getElementById('yearBtn').onclick = () => {
      const picker = document.getElementById('yearPicker');
      const grid = document.getElementById('yearGrid');
      grid.innerHTML = '';

      const currentYear = new Date().getFullYear();
      const years = [];
      for (let i = currentYear - 5; i <= currentYear + 10; i++) {
        years.push(i);
      }

      years.forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'picker-item';
        btn.textContent = year;
        if (year === calendarYear) btn.classList.add('selected');
        btn.onclick = () => {
          calendarYear = year;
          renderCalendar();
          picker.classList.remove('active');
        };
        grid.appendChild(btn);
      });

      picker.classList.add('active');
    };

    // Close pickers when clicking overlay
    document.getElementById('monthPicker').onclick = (e) => {
      if (e.target.id === 'monthPicker') {
        e.target.classList.remove('active');
      }
    };
    document.getElementById('yearPicker').onclick = (e) => {
      if (e.target.id === 'yearPicker') {
        e.target.classList.remove('active');
      }
    };

    // Month navigation
    document.getElementById('prevMonth').onclick = () => {
      calendarMonth--;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendar();
    };

    document.getElementById('nextMonth').onclick = () => {
      calendarMonth++;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      }
      renderCalendar();
    };

    // Duration tokens
    document.querySelectorAll('.duration-token').forEach(token => {
      token.onclick = () => {
        selectedDuration = parseInt(token.dataset.duration);
        document.getElementById('durationInput').value = selectedDuration;
      };
    });

    document.getElementById('durationInput').oninput = (e) => {
      selectedDuration = parseInt(e.target.value) || 1;
    };

    // Done button
    document.getElementById('doneBtn').onclick = () => {
      finalizeDateTimePicker();
    };

    // Function to finalize and return result
    function finalizeDateTimePicker() {
      const date = new Date(selectedDate);
      const hour24 = selectedPeriod === 'PM' ? (selectedHour % 12) + 12 : (selectedHour % 12);
      date.setHours(hour24, selectedMinute, 0, 0);

      function pad2(n){ return String(n).padStart(2,"0"); }
      function isoWithOffset(d){
        const offMin = -d.getTimezoneOffset();
        const sign = offMin >= 0 ? "+" : "-";
        const abs = Math.abs(offMin);
        const hh = pad2(Math.floor(abs / 60));
        const mm = pad2(abs % 60);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}${sign}${hh}:${mm}`;
      }

      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "local";
      const dtf = new Intl.DateTimeFormat(undefined, {
        weekday:"short", year:"numeric", month:"short", day:"2-digit",
        hour:"numeric", minute:"2-digit"
      });

      const payload = {
        v: 1,
        rid,
        status: "ok",
        type: "datetime",
        data: {
          iso: isoWithOffset(date),
          epochMs: date.getTime(),
          tz,
          display: dtf.format(date),
          durationMin: selectedDuration
        }
      };

      returnToShortcuts(cb, payload);
    }

    // Close button - cancel and return
    document.getElementById('closeBtn').onclick = () => {
      if (currentStep === 0) {
        returnToShortcuts(cb, { v:1, rid, status:"cancel", type:"datetime", data:null });
      } else {
        currentStep--;
        showView(currentStep);
        if (currentStep === 0) renderCalendar();
        if (currentStep === 1) renderTimePicker();
      }
    };

    // Initialize
    renderCalendar();
    showView(0);
    updateDisplay();
  </script>
</body>
</html>
